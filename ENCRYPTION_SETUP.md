# AES Encryption Setup Guide

## Overview
The PSAU Admission System now uses AES-256-GCM encryption to protect sensitive user and application data.

## What's Encrypted

### Users Table
- `first_name`
- `last_name`
- `email`
- `mobile_number`
- `gender`
- `birth_date`
- `address`

### Applications Table
- `previous_school`
- `school_year`
- `strand`
- `gpa`
- `address`
- `age`

## Setup Instructions

### 1. Generate Encryption Key

Run the key generation script:
```bash
php generate_encryption_key.php
```

This will:
- Generate a secure 32-byte encryption key
- Display the key for you to copy
- Automatically add it to your `.env` file

### 2. Configure .env File

Create or update your `.env` file with the encryption key:

```env
# Encryption Key (REQUIRED)
ENCRYPTION_KEY=your_generated_key_here

# Database Configuration
DB_HOST=localhost
DB_NAME=psau_admission
DB_USER=root
DB_PASS=
DB_PORT=3306
```

### 3. For Render.com Deployment

**Important:** You MUST add the encryption key to Render's environment variables.

1. Go to your Render Dashboard
2. Select your service
3. Go to **Environment** tab
4. Add environment variable:
   - **Key**: `ENCRYPTION_KEY`
   - **Value**: (paste the key generated by the script)
5. Save and redeploy

## How It Works

### Encryption on Save
- When users register, their personal data is encrypted before saving to the database
- When applications are submitted, application data is encrypted
- Data is transparently encrypted using AES-256-GCM

### Decryption on Retrieve
- When displaying data, it's automatically decrypted
- Users see plain text in the interface
- Admins see plain text in the admin panel
- The database stores encrypted data

### Security Features
- **AES-256-GCM**: Military-grade encryption algorithm
- **Unique context per field**: Each database field has its own encryption context
- **Environment-based key**: Encryption key is stored in .env file, not in code
- **Automatic handling**: Encryption/decryption happens transparently

## Testing

After setting up:
1. Register a new user
2. Check the database - data should be encrypted
3. Login - should work normally with decrypted data
4. View admin panel - should display decrypted data
5. Submit an application - data should be encrypted

## Troubleshooting

### "Invalid encryption key length" error
- Make sure you've run `php generate_encryption_key.php`
- Check that ENCRYPTION_KEY is set in .env file
- Verify the key is exactly 32 bytes when base64 decoded

### Data appears encrypted in display
- Make sure encryption.php is included in the file
- Verify the encryption key is correct
- Check error logs for decryption errors

### Can't find user by email/mobile
- Make sure the `find_user_by_encrypted_email()` and `find_user_by_encrypted_mobile()` functions are being used
- These functions search through all users to find matches (necessary for encrypted fields)

## Database Structure

**IMPORTANT:** No database schema changes are needed. The encryption works at the application level - data is encrypted before INSERT and decrypted after SELECT.

## Key Files Updated

1. **includes/encryption.php** - Core encryption library with helper functions
2. **public/register.php** - Encrypts user data on registration
3. **public/login.php** - Searches encrypted data for authentication
4. **public/application_form.php** - Encrypts application data on submission
5. **includes/session_checker.php** - Decrypts user data for sessions
6. **admin/view_all_users.php** - Decrypts user data for admin viewing
7. **admin/dashboard.php** - Decrypts application data for admin viewing

## Security Notes

- The encryption key is the only secret that needs to be protected
- Keep the .env file secure and don't commit it to version control
- Generate a new key for production environment
- If the key is compromised, all encrypted data becomes unusable
- Always backup your encryption key in a secure location

